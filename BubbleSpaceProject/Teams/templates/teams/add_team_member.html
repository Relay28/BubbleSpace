{% extends "base.html" %}

{% block content %}
<style>
    .search-box {
        transition: border-color 0.3s ease;
    }

    .search-box:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .suggestions {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #fff;
    }

    .suggestions li {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .suggestions li:hover {
        background-color: #f8f9fa;
    }

    .selected-member {
        display: inline-flex;
        align-items: center;
        margin: 0.5rem;
        padding: 0.5rem 0.75rem;
        background-color: #e9f7e1;
        color: #28a745;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .selected-member .remove-btn {
        margin-left: 0.5rem;
        background: none;
        border: none;
        color: #28a745;
        font-size: 1rem;
        cursor: pointer;
    }

    .selected-member .remove-btn:hover {
        color: #dc3545;
    }
</style>

<div class="container mt-5">
    <h1 class="text-center text-dark">Add Members to {{ team.team_name }}</h1>

    <div class="my-4">
        <input 
            type="text" 
            id="search-box" 
            class="form-control search-box" 
            placeholder="Search for a username..." 
            autocomplete="off"
        >
        <ul id="suggestions" class="suggestions mt-2"></ul>
    </div>

    <div id="selected-members-container" class="border rounded p-3 bg-white shadow-sm">
        <h3 class="text-success">Selected Members</h3>
        <div id="selected-members" class="d-flex flex-wrap"></div>
    </div>

    <form method="post" class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="members" id="members-input"> <!-- Hidden input for selected members -->
        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-success me-3">Add Members</button>
            <a href="{% url 'team_detail' team.pk %}" class="btn btn-danger">Back to Team</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchBox = document.getElementById('search-box');
        const suggestions = document.getElementById('suggestions');
        const selectedMembersContainer = document.getElementById('selected-members');
        const membersInput = document.getElementById('members-input');
        const teamId = "{{ team.id|safe }}";

        let selectedMembers = [];

        searchBox.addEventListener('input', function() {
            const query = searchBox.value.trim();
            if (query.length > 0) {
                fetch(`/bubblespace/teams/search-members/?q=${encodeURIComponent(query)}&team_id=${teamId}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestions.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(user => {
                                const li = document.createElement('li');
                                li.textContent = user.username;
                                li.dataset.id = user.id;
                                li.className = 'list-group-item';
                                li.addEventListener('click', function() {
                                    addMember(user);
                                });
                                suggestions.appendChild(li);
                            });
                        } else {
                            suggestions.innerHTML = '<li class="list-group-item text-muted">No users found</li>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user suggestions:', error);
                        suggestions.innerHTML = `<li class="list-group-item text-danger">Error: ${error.message}</li>`;
                    });
            } else {
                suggestions.innerHTML = '';
            }
        });

        function addMember(user) {
            if (!selectedMembers.some(member => member.id === user.id)) {
                selectedMembers.push(user);
                updateSelectedMembers();
            }
            searchBox.value = '';
            suggestions.innerHTML = '';
        }

        function removeMember(userId) {
            selectedMembers = selectedMembers.filter(member => member.id !== userId);
            updateSelectedMembers();
        }

        function updateSelectedMembers() {
            selectedMembersContainer.innerHTML = '';
            selectedMembers.forEach(member => {
                const chip = document.createElement('div');
                chip.className = 'selected-member';
                chip.textContent = member.username;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Ã—';
                removeBtn.addEventListener('click', () => removeMember(member.id));

                chip.appendChild(removeBtn);
                selectedMembersContainer.appendChild(chip);
            });

            membersInput.value = selectedMembers.map(member => member.id).join(',');
            console.log("Selected members input value:", membersInput.value); 
        }
    });
</script>
{% endblock %}
