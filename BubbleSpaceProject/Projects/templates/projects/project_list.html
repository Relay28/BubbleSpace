{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Project Task List</title>
    <link rel="stylesheet" href="{% static 'css/project_list.css' %}">
    <style>
        /* Styling for the horizontal form layout */
        .task-form-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .task-form-container .form-group {
            flex: 1 1 20%; /* Make form fields take equal space */
            display: flex;
            flex-direction: column;
        }
        .task-form-container .form-group label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .task-form-container .form-group input,
        .task-form-container .form-group select,
        .task-form-container .form-group textarea {
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-shadow: none;
        }
        .task-form-container .form-group textarea {
            height: 50px;
            resize: none;
        }
        .task-form-container .form-group select,
        .task-form-container .form-group input[type="date"] {
            height: 40px;
        }
        .task-form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>

<body>
    {% include "base.html" %}

    <div class="container">
        <div class="back-button-container" style="margin: 10px;">
            <a href="#" onclick="history.back(); return false;" class="btn btn-primary btn-sm" style="text-decoration: none;">
                &larr; Back
            </a>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h4 text-primary">Tasks in {{ project.Title }}</h1>
            <button id="addTaskButton" class="btn btn-sm btn-success">
                Add New Task
            </button>
        </div>

        <!-- Task Form (Create New Task) -->
        <div id="taskFormContainer" class="mb-4" style="display: none;">
            <form id="task-create-form" data-project-id="{{ project.ProjectId }}">
            {% csrf_token %}
            <div class="task-form-container">
                <div class="form-group">
                    <label for="id_title">Task Title</label>
                    {{ form.title }}
                </div>
                <div class="form-group">
                    <label for="id_description">Description</label>
                    {{ form.description }}
                </div>
                <div class="form-group">
                    <label for="id_category">Category</label>
                    {{ form.category }}
                </div>
                <div class="form-group">
                    <label for="id_assigned_to">Assigned To</label>
                    {{ form.assigned_to }}
                </div>
                <div class="form-group">
                    <label for="id_due_date">Due Date</label>
                    {{ form.due_date }}
                </div>
                <div class="form-group">
                    <label for="id_status">Status</label>
                    {{ form.status }}
                </div>
            </div>
            <div class="task-form-buttons">
                <button type="submit" class="btn btn-primary">Add Task</button>
            </div>
        </form>
        </div>

        <!-- Task List Header -->
        <div class="task-list-header">
            <div>Task Title</div>
            <div>Category</div>
            <div>Assigned To</div>
            <div>Due Date</div>
            <div>Status</div>
            <div>Actions</div>
        </div>

        <!-- Task List -->
        <div class="task-list-container">
            {% if tasks %}
                {% for task in tasks %}
                <div class="task-item" id="task-{{ task.pk }}">
                    <div class="task-item-content">
                        <span><strong>{{ task.title }}</strong></span>
                        <span>{{ task.category }}</span>
                        <span>{{ task.assigned_to }}</span>
                        <span>{{ task.due_date|date:"M d, Y" }}</span>

                        <span class="status-icon-container">
                            <div class="status-icon {% if task.status == 'green' %}bg-success{% elif task.status == 'yellow' %}bg-warning{% else %}bg-danger{% endif %}"
                                data-task-id="{{ task.pk }}" data-status="{{ task.status }}">
                                {% if task.status == 'green' %}
                                <i class="bi bi-check-circle" style="font-size: 14px;"></i>
                                {% elif task.status == 'yellow' %}
                                <i class="bi bi-clock" style="font-size: 14px;"></i>
                                {% else %}
                                <i class="bi bi-list-check" style="font-size: 14px;"></i>
                                {% endif %}
                            </div>
                        </span>

                        <span class="task-actions">
                            <button class="btn btn-link btn-sm edit-task-btn" data-task-id="{{ task.pk }}">
                                Edit
                            </button>
                            <button class="btn btn-link btn-sm text-danger delete-task-btn" data-task-id="{{ task.pk }}">
                                Delete
                            </button>
                        </span>
                    </div>

                    <!-- Edit Task Form (Inline) -->
                    <div class="edit-task-form" id="edit-form-{{ task.pk }}" style="display: none;">
                        <form method="post" data-task-id="{{ task.pk }}" class="edit-task-form">
                            {% csrf_token %}
                            <div class="task-form-container">
                                <div class="form-group">
                                    <label for="id_title_{{ task.pk }}">Task Title</label>
                                    <input 
                                        type="text" 
                                        id="id_title_{{ task.pk }}" 
                                        name="title" 
                                        value="{{ task.title }}" 
                                        class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_description_{{ task.pk }}">Description</label>
                                    <textarea 
                                        id="id_description_{{ task.pk }}" 
                                        name="description" 
                                        class="form-control">{{ task.description }}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="id_category_{{ task.pk }}">Category</label>
                                    <select 
                                        id="id_category_{{ task.pk }}" 
                                        name="category" 
                                        class="form-control">
                                        <option value="Category1" {% if task.category == "Category1" %}selected{% endif %}>Category1</option>
                                        <option value="Category2" {% if task.category == "Category2" %}selected{% endif %}>Category2</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="id_assigned_to_{{ task.pk }}">Assigned To</label>
                                    <input 
                                        type="text" 
                                        id="id_assigned_to_{{ task.pk }}" 
                                        name="assigned_to" 
                                        value="{{ task.assigned_to }}" 
                                        class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_due_date_{{ task.pk }}">Due Date</label>
                                    <input 
                                        type="date" 
                                        id="id_due_date_{{ task.pk }}" 
                                        name="due_date" 
                                        value="{{ task.due_date|date:'Y-m-d' }}" 
                                        class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_status_{{ task.pk }}">Status</label>
                                    <select 
                                        id="id_status_{{ task.pk }}" 
                                        name="status" 
                                        class="form-control">
                                        <option value="green" {% if task.status == "green" %}selected{% endif %}>Completed</option>
                                        <option value="yellow" {% if task.status == "yellow" %}selected{% endif %}>In Progress</option>
                                        <option value="red" {% if task.status == "red" %}selected{% endif %}>Not Started</option>
                                    </select>
                                </div>
                            </div>
                            <div class="task-form-buttons">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                    
                {% endfor %}
            {% else %}
                <p>No tasks found for this project.</p>
            {% endif %}
        </div>
    </div>
<script>
 document.addEventListener("DOMContentLoaded", () => {
    const taskFormContainer = document.getElementById("taskFormContainer");
    const addTaskButton = document.getElementById("addTaskButton");

    // Show task form on "Add Task" button click
    addTaskButton.addEventListener("click", () => {
        taskFormContainer.style.display = "block";
        addTaskButton.style.display = "none";
    });

    const taskCreateForm = document.getElementById("task-create-form");

taskCreateForm.addEventListener("submit", (event) => {
    event.preventDefault(); // Prevent the form's default submission behavior

    const formData = new FormData(taskCreateForm);
    const projectId = taskCreateForm.getAttribute("data-project-id");

    fetch(`/bubblespace/projects/project_tasks/create/${projectId}/`, {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
        },
    })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((data) => {
                    throw new Error(data.error || "Failed to create task.");
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.success) {
                //alert(data.message);
                location.reload(); // Optionally reload the page or update the task list dynamically
            } else {
                alert("Task creation failed: " + JSON.stringify(data.errors));
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred: " + error.message);
        });
});

    // Event delegation for edit buttons
    document.addEventListener("click", (event) => {
        if (event.target.classList.contains("edit-task-btn")) {
            const taskId = event.target.getAttribute("data-task-id");
            const editForm = document.getElementById(`edit-form-${taskId}`);
            if (editForm) {
                editForm.style.display = editForm.style.display === "none" ? "block" : "none";
            }
        } else if (event.target.classList.contains("cancel-edit-btn")) {
            const taskId = event.target.getAttribute("data-task-id");
            const editForm = document.getElementById(`edit-form-${taskId}`);
            if (editForm) {
                editForm.style.display = "none";
            }
        }
    });

    // Handle task deletion
    document.addEventListener("click", (event) => {
        if (event.target.classList.contains("delete-task-btn")) {
            const taskId = event.target.getAttribute("data-task-id");
            const confirmed = confirm("Are you sure you want to delete this task?");
            if (confirmed) {
                fetch(`/bubblespace/projects/project_task/delete/${taskId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
                        "Content-Type": "application/json",
                    },
                })
                    .then((response) => {
                        if (response.ok) {
                            document.getElementById(`task-${taskId}`).remove();
                        } else {
                            throw new Error("Failed to delete task.");
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert("An error occurred while deleting the task.");
                    });
            }
        }
    });

    // Handle task editing
    document.addEventListener("submit", (event) => {
        if (event.target.classList.contains("edit-task-form")) {
            event.preventDefault();
            const taskId = event.target.getAttribute("data-task-id");
            const formData = new FormData(event.target);

            fetch(`/bubblespace/projects/project_tasks/edit/${taskId}/`, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
                },
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((data) => {
                            throw new Error(data.error || "Failed to save task.");
                        });
                    }
                    return response.json();
                })
                .then((data) => {
                    if (data.success) {
                        const taskElement = document.getElementById(`task-${taskId}`);
                        taskElement.querySelector(".task-item-content span:nth-child(1)").textContent = data.updated_title;
                        taskElement.querySelector(".task-item-content span:nth-child(2)").textContent = data.updated_description;
                        taskElement.querySelector(".task-item-content span:nth-child(3)").textContent = data.updated_category;
                        taskElement.querySelector(".task-item-content span:nth-child(4)").textContent = data.updated_assigned_to;
                        taskElement.querySelector(".task-item-content span:nth-child(5)").textContent = data.updated_due_date;

                        const statusIcon = taskElement.querySelector(".status-icon");
                        statusIcon.className = `status-icon ${data.updated_status}`;
                        statusIcon.innerHTML = data.updated_status_icon;

                        document.getElementById(`edit-form-${taskId}`).style.display = "none";
                    } else {
                        alert("Error saving task: " + data.errors);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert(error.message || "An error occurred while saving the task.");
                });
        }
    });
});

</script>    
</body>

</html>
