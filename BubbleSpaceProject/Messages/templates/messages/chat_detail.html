{% extends "base.html" %}

{% block content %}
<div class="chat-window">
    <h3>Chat with {{ chat.recipient if chat.sender == request.user else chat.sender }}</h3>
    <div class="messages">
        {% for message in messages %}
            <div class="{% if message.sender == request.user %}outgoing{% else %}incoming{% endif %}">
                <p>{{ message.message }}</p>
                <span>{{ message.date_sent }}</span>
            </div>
        {% endfor %}
    </div>
    <form method="post">
        {% csrf_token %}
        {{ form }}
        <button type="submit">Send</button>
    </form>
</div>
{% endblock %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const chatId = "{{ chat.id }}";  // Pass the chat ID to the script
        let lastCheck = new Date().toISOString();  // Start with the current timestamp
    
        function fetchNewMessages() {
            fetch(`/messages/${chatId}/messages/?last_check=${lastCheck}`)
                .then(response => response.json())
                .then(data => {
                    const messageContainer = document.querySelector(".messages");
                    
                    data.new_messages.forEach(msg => {
                        // Create message HTML element
                        const messageElement = document.createElement("div");
                        messageElement.classList.add("incoming");
                        messageElement.innerHTML = `
                            <p><strong>${msg.sender}</strong>: ${msg.message}</p>
                            <span>${msg.date_sent}</span>
                        `;
                        messageContainer.appendChild(messageElement);
                    });
    
                    // Update lastCheck timestamp to the most recent message time
                    if (data.new_messages.length > 0) {
                        lastCheck = new Date().toISOString();
                    }
                })
                .catch(error => console.error("Error fetching new messages:", error));
        }
    
        // Fetch new messages every 5 seconds
        setInterval(fetchNewMessages, 5000);
    });
    </script>
    <script>
        function getCSRFToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            return csrfToken;
        }
        </script>
        